<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Currency Converter â€¢ Luxe Theme</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="wrap">
      <!-- Top bar -->
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Currency Converter</h1>
        </div>
        <div class="actions">
          <span class="badge" id="rateMeta" aria-live="polite">loadingâ€¦</span>
          <button id="themeToggle" class="toggle" aria-pressed="false" aria-label="Toggle light/dark theme">ðŸŒ™ Dark</button>
        </div>
      </div>

      <!-- Converter -->
      <section class="card" aria-label="converter">
        <div class="converter">
          <div>
            <label for="amount">Amount</label>
            <input id="amount" type="number" step="0.01" min="0" value="100" placeholder="Enter amount" />
          </div>
          <div>
            <label for="from">From</label>
            <select id="from" aria-label="From currency"></select>
          </div>
          <div>
            <label for="to">To</label>
            <select id="to" aria-label="To currency"></select>
          </div>
          <div class="btns">
            <button id="swap" class="btn" title="Swap currencies">â†” Swap</button>
            <button id="convert" class="btn primary" title="Convert now">Convert</button>
          </div>
        </div>

        <!-- Quick picks -->
        <div class="quickpicks" aria-label="quick picks">
          <span class="chip" data-pair="USD,EUR">USDâ†’EUR</span>
          <span class="chip" data-pair="EUR,USD">EURâ†’USD</span>
          <span class="chip" data-pair="USD,INR">USDâ†’INR</span>
          <span class="chip" data-pair="USD,NPR">USDâ†’NPR</span>
          <span class="chip" data-pair="GBP,USD">GBPâ†’USD</span>
          <span class="chip" data-pair="USD,JPY">USDâ†’JPY</span>
        </div>

        <!-- Result -->
        <div class="result">
          <div>
            <div class="big" id="resultText" aria-live="polite">â€”</div>
            <div class="muted" id="rateText"></div>
          </div>
          <div class="btns">
            <button id="copy" class="btn" title="Copy result">Copy result</button>
            <button id="clearHistory" class="btn" title="Clear saved history">Clear history</button>
          </div>
        </div>
      </section>

      <!-- History -->
      <section class="card grid" aria-label="history">
        <div class="grid-head">
          <h2>Conversion History</h2>
          <span class="muted" id="historyMeta">local only</span>
        </div>
        <div>
          <table id="historyTable" aria-describedby="historyMeta">
            <thead>
              <tr>
                <th>When</th>
                <th>From</th>
                <th>To</th>
                <th>Rate</th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr><td colspan="5" class="empty">No conversions yet.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <footer>
        Powered by Frankfurter.app (no API key). Rates are for demo use only.
      </footer>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
      // ===== Config =====
      const API_BASE = "https://api.frankfurter.app";
      const LS_KEY = "cc_history_v1";
      const THEME_KEY = "cc_theme";
      const DEFAULTS = { from: "USD", to: "EUR" };

      // Elements
      const els = {
        amount: document.getElementById("amount"),
        from: document.getElementById("from"),
        to: document.getElementById("to"),
        convert: document.getElementById("convert"),
        swap: document.getElementById("swap"),
        copy: document.getElementById("copy"),
        clearHistory: document.getElementById("clearHistory"),
        resultText: document.getElementById("resultText"),
        rateText: document.getElementById("rateText"),
        rateMeta: document.getElementById("rateMeta"),
        historyBody: document.getElementById("historyBody"),
        historyMeta: document.getElementById("historyMeta"),
        toast: document.getElementById("toast"),
        themeToggle: document.getElementById("themeToggle"),
        chips: () => Array.from(document.querySelectorAll(".chip")),
      };

      // Fallback currency names
      const COMMON = {
        USD: "US Dollar",
        EUR: "Euro",
        GBP: "British Pound",
        JPY: "Japanese Yen",
        AUD: "Australian Dollar",
        CAD: "Canadian Dollar",
        INR: "Indian Rupee",
        NPR: "Nepalese Rupee",
        CNY: "Chinese Yuan",
        CHF: "Swiss Franc",
        SEK: "Swedish Krona",
        NZD: "New Zealand Dollar",
      };

      // ===== Theme handling =====
      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        els.themeToggle.setAttribute("aria-pressed", String(theme === "light"));
        els.themeToggle.textContent = theme === "light" ? "ðŸŒž Light" : "ðŸŒ™ Dark";
      }
      function initTheme() {
        const saved = localStorage.getItem(THEME_KEY);
        if (saved) return applyTheme(saved);
        const prefersLight = window.matchMedia("(prefers-color-scheme: light)").matches;
        applyTheme(prefersLight ? "light" : "dark");
      }

      // ===== Toast =====
      let toastTimer = null;
      function showToast(msg, type = "ok", ms = 1600) {
        els.toast.textContent = msg;
        els.toast.className = `toast show ${type}`;
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => (els.toast.className = "toast"), ms);
      }

      // ===== API helpers =====
      async function fetchSymbols() {
        try {
          const res = await fetch(`${API_BASE}/currencies`);
          if (!res.ok) throw new Error("Failed to load symbols");
          const data = await res.json();
          if (data && typeof data === "object") {
            return Object.entries(data).reduce((acc, [code, description]) => {
              acc[code] = { description, code };
              return acc;
            }, {});
          }
          throw new Error("Bad symbols response");
        } catch (e) {
          console.warn("Symbols fetch failed, using fallback", e);
          return Object.entries(COMMON).reduce((acc, [code, name]) => {
            acc[code] = { description: name, code };
            return acc;
          }, {});
        }
      }

      function populateSelects(symbols) {
        const entries = Object.keys(symbols)
          .sort()
          .map((k) => ({ code: k, name: symbols[k].description || k }));
        for (const el of [els.from, els.to]) {
          el.innerHTML = "";
          entries.forEach(({ code, name }) => {
            const opt = document.createElement("option");
            opt.value = code;
            opt.textContent = `${code} â€” ${name}`;
            el.appendChild(opt);
          });
        }
        els.from.value = DEFAULTS.from in symbols ? DEFAULTS.from : entries[0].code;
        els.to.value = DEFAULTS.to in symbols ? DEFAULTS.to : entries[1].code;
      }

      function saveHistory(entry) {
        const arr = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
        arr.unshift(entry);
        localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0, 20)));
      }
      function loadHistory() {
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      }

      function renderHistory() {
        const rows = loadHistory();
        if (!rows.length) {
          els.historyBody.innerHTML = '<tr><td colspan="5" class="empty">No conversions yet.</td></tr>';
          return;
        }
        els.historyBody.innerHTML = rows
          .map(
            (r) => `
            <tr>
              <td>${new Date(r.ts).toLocaleString()}</td>
              <td>${r.amount.toLocaleString()} ${r.from}</td>
              <td>${r.to}</td>
              <td>1 ${r.from} = ${r.rate.toFixed(6)} ${r.to}</td>
              <td><strong>${r.result.toLocaleString(undefined,{maximumFractionDigits:4})} ${r.to}</strong></td>
            </tr>`
          )
          .join("");
      }

      async function convert() {
        const amount = parseFloat(els.amount.value);
        const from = els.from.value;
        const to = els.to.value;
        if (!(amount >= 0)) return showToast("Enter a valid amount (â‰¥ 0).", "err");
        if (from === to) return showToast("Choose two different currencies.", "err");
        try {
          els.rateMeta.textContent = "fetchingâ€¦";
          const url = `${API_BASE}/latest?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error("Rate request failed");
          const data = await res.json();
          const rate = data && data.rates && typeof data.rates[to] === "number" ? data.rates[to] : null;
          if (!rate) throw new Error("Unexpected API response");
          const result = amount * rate;

          els.resultText.textContent = `${amount.toLocaleString()} ${from} â†’ ${result.toLocaleString(undefined, {
            maximumFractionDigits: 4,
          })} ${to}`;
          els.rateText.textContent = `1 ${from} = ${rate.toFixed(6)} ${to} â€¢ ${new Date(
            data.date || Date.now()
          ).toLocaleDateString()}`;
          els.rateMeta.textContent = "live";

          saveHistory({ ts: Date.now(), amount, from, to, rate, result });
          renderHistory();
        } catch (err) {
          console.error(err);
          els.rateMeta.textContent = "error";
          showToast("Conversion failed. Check your network.", "err");
        }
      }

      function swap() {
        const a = els.from.value;
        els.from.value = els.to.value;
        els.to.value = a;
      }

      function clearHistory() {
        if (!confirm("Clear all saved conversions?")) return;
        localStorage.removeItem(LS_KEY);
        renderHistory();
      }

      function copyResult() {
        const text = els.resultText.textContent.trim();
        if (!text || text === "â€”") return;
        navigator.clipboard.writeText(text).then(() => showToast("Copied!"));
      }

      // ===== Init =====
      (async function init() {
        initTheme();
        const symbols = await fetchSymbols();
        populateSelects(symbols);
        renderHistory();

        // events
        els.convert.addEventListener("click", convert);
        els.swap.addEventListener("click", () => {
          swap();
          convert();
        });
        els.copy.addEventListener("click", copyResult);
        els.clearHistory.addEventListener("click", clearHistory);
        els.themeToggle.addEventListener("click", () => {
          const current = document.documentElement.getAttribute("data-theme") || "dark";
          const next = current === "light" ? "dark" : "light";
          localStorage.setItem(THEME_KEY, next);
          applyTheme(next);
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Enter") convert();
        });
        els.chips().forEach((chip) =>
          chip.addEventListener("click", () => {
            const [f, t] = chip.dataset.pair.split(",");
            els.from.value = f;
            els.to.value = t;
            convert();
          })
        );

        // first conversion
        convert();
      })();
    </script>
  </body>
</html>
